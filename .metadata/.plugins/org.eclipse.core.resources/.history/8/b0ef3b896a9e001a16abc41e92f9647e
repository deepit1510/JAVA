package Reorder;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.*;
import javax.mail.*;
import javax.mail.internet.*;
import javax.activation.*;
import javax.mail.Session;
import javax.mail.Transport;

public class SendEmail {

	

	static final String JDBC_DRIVER = "com.mysql.jdbc.Driver";
	static final String DB_URL = "jdbc:mysql://localhost/inventory_control_management";
	static final String USER = "root";
	static final String PASS = "";

	public static void item_display() {
		Connection conn = null;
		Statement stmt = null;

		try {

			Class.forName("com.mysql.jdbc.Driver");
			System.out.println("Connecting to database...");
			conn = DriverManager.getConnection(DB_URL, USER, PASS);
			System.out.println("Creating statement...");
			stmt = conn.createStatement();
			String sql;
			sql = "SELECT item_id, item_name, sup_id, eoq  FROM item where crt_stk<=re_order_lvl";
			ResultSet rs = stmt.executeQuery(sql);

			while (rs.next()) {

				int id = rs.getInt("item_id");
				int sup_id = rs.getInt("sup_id");
				String item_name = rs.getString("item_name");
				Double eoq = rs.getDouble("eoq");
				String sql1;
				sql1 = "SELECT sup_email from supplier where sup_id="+sup_id;
				ResultSet rs1 = stmt.executeQuery(sql1);
				String sup_email = rs.getString("sup_email");
				sende(sup_email,id,item_name,eoq);
				rs1.close();
				
			}

			rs.close();
			stmt.close();
			conn.close();
		} catch (SQLException se) {
			se.printStackTrace();
		} catch (Exception e) {
			// Handle errors for Class.forName
			e.printStackTrace();
		} finally {
			// finally block used to close resources
			try {
				if (stmt != null)
					stmt.close();
			} catch (SQLException se) {
				se.printStackTrace();
			} // end finally
		} // end try
		System.out.println("Goodbye.");
	}

	public static void sende(String sup_email,int item_id,String item_name,Double eoq) {
		// email ID of Recipient.
		String recipient = sup_email;

		// email ID of Sender.
		String sender = "deepit.aggarwal00@gmail.com";

		// using host as localhost
		String host = "127.0.0.1";

		// Getting system properties
		Properties properties = System.getProperties();

		// Setting up mail server
		properties.setProperty("mail.smtp.host", host);

		// creating session object to get properties
		Session session = Session.getDefaultInstance(properties);

		try {
			// MimeMessage object.
			MimeMessage message = new MimeMessage(session);

			// Set From Field: adding senders email to from field.
			message.setFrom(new InternetAddress(sender));

			// Set To Field: adding recipient's email to from field.
			message.addRecipient(Message.RecipientType.TO, new InternetAddress(recipient));

			// Set Subject: subject of the email
			message.setSubject("Placing an order");

			// set body of the email.
			message.setText("We are here by placing an order for the quantity equivalent to "+eoq+"for item id:-"+item_id+"and item name:-"+item_name);

			// Send email.
			Transport.send(message);
			System.out.println("Mail successfully sent");
		} 
		catch (MessagingException mex) {
			mex.printStackTrace();
		}
	}
}
